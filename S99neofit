#!/bin/sh
# /opt/etc/init.d/S99neofit
#chmod +x  /opt/etc/init.d/S99neofit
# üí° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NeoFit –¥–ª—è sing-box: —É—Å—Ç–∞–Ω–æ–≤–∫–∞, —É–¥–∞–ª–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —Ç.–¥. –¥–æ–ø–∏–ª–∏–≤–∞—é –¥–æ –∏–¥–µ–∞–ª–∞))

ACTION="$1"

# üõ† –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–º–ª–∏–Ω–∫–∞ neofit
# üõ† –°–æ–∑–¥–∞—ë–º —Å–∏–º–ª–∏–Ω–∫ –Ω–∞ —Å–µ–±—è
SCRIPT_PATH="$(readlink -f "$0")"
mkdir -p /opt/bin
ln -sf "$SCRIPT_PATH" /opt/bin/neofit && \
  printf "[‚öôÔ∏è] –í–≤–µ–¥–∏—Ç–µ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏: neofit\n"

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ br0
ip_address=$(ip addr show br0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_ok()   { echo -e "${GREEN}[‚úÖ]${NC} $1"; logger -t S99neofit "‚úÖ $1"; }
log_warn() { echo -e "${YELLOW}[‚ö†Ô∏è]${NC} $1"; logger -t S99neofit "‚ö†Ô∏è $1"; }
log_err()  { echo -e "${RED}[‚ùå]${NC} $1" >&2; logger -t S99neofit "‚ùå $1"; }
log()      { echo -e "${GREEN}[‚ÑπÔ∏è]${NC} $1"; logger -t S99neofit "‚ÑπÔ∏è $1"; }

if [ -z "$ip_address" ]; then
  log_err "‚ö†Ô∏è–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å IP br0 ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
  exit 1
fi

entware_silent() { "$@" >/dev/null 2>&1; }
ndmc_silent() {
  ndmc -c "$1" >/dev/null 2>&1
}

check_status() {
  STATUS=$(/opt/etc/init.d/S99sing-box status)
  if echo "$STATUS" | grep -qi "alive"; then
    log_ok "üîú sing-box ‚úÖ—Ä–∞–±–æ—Ç–∞–µ—Ç:\n $STATUS"
  elif echo "$STATUS" | grep -qi "dead"; then
    log_err "üîú sing-box ‚ùå–ù–ï –∑–∞–ø—É—â–µ–Ω:\n $STATUS"
  else
    log_warn "üîú sing-box ‚ö†Ô∏è–û—à–∏–±–∫–∞:\n $STATUS"
  fi
}

if [ "$ACTION" = "start" ] || [ "$ACTION" = "restart" ]; then
  log_warn "üóëÔ∏è –£–¥–∞–ª—è—é link –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ opkgtun0"
  entware_silent /opt/sbin/ip link delete opkgtun0
  log_warn "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–ª—É–∂–±—É sing-box"
  entware_silent /opt/etc/init.d/S99sing-box restart
  sleep 2
  check_status
  exit 0
fi

if [ "$ACTION" = "status" ]; then
  check_status
  exit 0
fi

if [ "$ACTION" = "stop" ]; then
  log_warn "‚ùå–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–ª—É–∂–±—É sing-box"
  entware_silent /opt/etc/init.d/S99sing-box stop
  sleep 2
  check_status
  exit 0
fi

log_warn "$0 \n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: neofit {start|stop|restart|status}\n–ù–∞—à –∫–∞–Ω–∞–ª: t.me/neofitkeenetic \n–ù–∞—à —á–∞—Ç: t.me/+f_8QmNYgg180Njg6 \nGitHub: github.com/pegakmop/neofit"
exit 1
