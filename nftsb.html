<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>NeoFit sing-box</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      --bg: #1e1e1e;
      --fg: #c9d1d9;
      --border: #555;
      --card: #282c34;
      --btn: #444;
      --btnfg: #fff;
      margin: 0;
      padding: 20px;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    h1 {
      text-align: center;
      margin: 0 0 24px;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 16px;
    }
    button {
      background: var(--btn);
      color: var(--btnfg);
      border: none;
      border-radius: 20px;
      padding: 10px 16px;
      cursor: pointer;
    }
    .interface-container {
      border: 1px solid var(--border);
      background: var(--card);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }
    .interface-header {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--card);
      color: var(--fg);
    }
    .link-field {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .config-display {
      border: 1px solid var(--border);
      background: var(--card);
      padding: 10px;
      border-radius: 6px;
      max-height: 60vh;
      overflow: auto;
    }
    #warnings {
      color: #ff6b6b;
      margin-top: 8px;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    .back-btn {
      background: #555;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <button class="back-btn" onclick="location.href='/'">‚Üê –ù–∞–∑–∞–¥</button>
  </div>

  <h1>NeoFit sing-box</h1>

  <div class="controls">
    <button><a href="https://yoomoney.ru/to/410012481566554">–Ω–∞ ‚òïÔ∏è –Æ–º–∞–Ω–∏</a></button>
    <button><a href="https://www.tinkoff.ru/rm/seroshtanov.aleksey9/HgzXr74936">–Ω–∞ ‚òïÔ∏è–¢–∏–Ω—å–∫–æ—Ñ—Ñ</a></button>
    <button onclick="addInterface()">üÜï–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</button>
    <button onclick="generateConfig()">üÜó–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥</button>
    <button onclick="saveConfig()">üÜô–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Ä–æ—É—Ç–µ—Ä</button>
  </div>

  <div id="warnings"></div>
  <div id="interfacesContainer"></div>

  <div id="configDisplay" class="config-display" style="display:none;">
    <pre><code id="output" class="language-json"></code></pre>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script>
    let config = {}, interfaceCount = 0;

    function addInterface() {
      interfaceCount++;
      const container = document.createElement('div');
      container.className = 'interface-container';
      container.id = 'interface-' + interfaceCount;

      const header = document.createElement('div');
      header.className = 'interface-header';
      const delBtn = document.createElement('button');
      delBtn.textContent = 'üóëÔ∏è';
      delBtn.title = '–£–¥–∞–ª–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å';
      delBtn.onclick = () => container.remove();
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = '–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Proxy0)';
      nameInput.value = 'Proxy' + (interfaceCount - 1);
      nameInput.maxLength = 20;

      header.appendChild(delBtn);
      header.appendChild(nameInput);
      container.appendChild(header);

      const linksContainer = document.createElement('div');
      linksContainer.className = 'links-container';
      container.appendChild(linksContainer);

      document.getElementById('interfacesContainer').appendChild(container);
      addLinkField(linksContainer);
    }

    function addLinkField(container) {
      const row = document.createElement('div');
      row.className = 'link-field';
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'vless://...';
      row.appendChild(input);
      container.appendChild(row);
    }

    function pickIndexFromName(name, fallbackIdx) {
      const m = String(name || '').match(/(\d+)$/);
      return m ? parseInt(m[1], 10) : fallbackIdx;
    }

    function parseVlessForSingbox(link) {
      const m = link.match(/vless:\/\/([^@]+)@([^:]+):(\d+)(?:\/?\?([^#]*))?(?:#(.*))?/);
      if (!m) return null;
      const uuid = m[1], server = m[2], server_port = parseInt(m[3], 10);
      const q = new URLSearchParams(m[4] || '');
      const tag = decodeURIComponent(m[5] || '').trim() || ('vless-' + server + '-' + server_port);
      const o = {
        type: 'vless',
        tag,
        server,
        server_port,
        uuid,
        packet_encoding: q.get('pe') || 'xudp'
      };
      const sec = q.get('security') || 'none';
      if (sec === 'tls' || sec === 'reality') {
        o.tls = {
          enabled: true,
          server_name: q.get('sni') || server,
          insecure: false,
          utls: {
            enabled: true,
            fingerprint: q.get('fp') || 'chrome'
          }
        };
        if (sec === 'reality') {
          o.tls.reality = {
            enabled: true,
            public_key: q.get('pbk') || '',
            short_id: q.get('sid') || ''
          };
        }
      }
      const flow = q.get('flow');
      if (flow) o.flow = flow;
      return o;
    }

    function generateConfig() {
      const cfg = {
        experimental: {
          cache_file: { enabled: true },
          clash_api: {
            external_controller: '0.0.0.0:9090',
            external_ui: 'ui',
            access_control_allow_private_network: true
          }
        },
        log: { level: 'debug', timestamp: true },
        inbounds: [],
        outbounds: [],
        route: { auto_detect_interface: false, rules: [], final: 'direct' }
      };

      const usedTags = new Set(), usedPorts = new Set();
      const interfaces = document.querySelectorAll('.interface-container');

      interfaces.forEach((ic, idx) => {
        const rawName = (ic.querySelector('.interface-header input[type="text"]')?.value || '').trim();
        const n = pickIndexFromName(rawName, idx);
        const tagInbound = ('proxy' + n).toLowerCase();
        let listen_port = 1081 + n;
        while (usedPorts.has(listen_port)) listen_port++;
        usedPorts.add(listen_port);

        cfg.inbounds.push({
          type: 'mixed',
          tag: tagInbound,
          listen: '0.0.0.0',
          listen_port,
          sniff: true,
          sniff_override_destination: false
        });

        const links = ic.querySelectorAll('.links-container input[type="text"]');
        for (const inp of links) {
          const raw = (inp.value || '').trim();
          if (!raw || !raw.startsWith('vless://')) continue;
          const o = parseVlessForSingbox(raw);
          if (!o) continue;
          if (!usedTags.has(o.tag)) {
            cfg.outbounds.push(o);
            usedTags.add(o.tag);
          }
          cfg.route.rules.push({
            inbound: [tagInbound],
            action: 'route',
            outbound: o.tag
          });
          break;
        }
      });

      cfg.outbounds.push({ type: 'direct', tag: 'direct' });
      cfg.outbounds.push({ type: 'block', tag: 'block' });
      cfg.route.rules.unshift({
        network: 'udp',
        port: 443,
        action: 'route',
        outbound: 'block'
      });

      config = cfg;

      const out = document.getElementById('output');
      out.textContent = JSON.stringify(config, null, 2);
      if (window.hljs) hljs.highlightElement(out);
      document.getElementById('configDisplay').style.display = 'block';
    }

    function saveConfig() {
      const warn = document.getElementById('warnings');
      if (!config || !config.inbounds || !config.inbounds.length) {
        warn.innerHTML = '‚ùå–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
        return;
      }
      fetch('/api/singbox', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config, null, 2)
      })
        .then(r => r.json())
        .then(d => alert(d.message || '–ì–æ—Ç–æ–≤–æ'))
        .catch(e => {
          console.error(e);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–Ω—Ñ–∏–≥–∞');
        });
    }
  </script>
</body>
</html>
