#!/bin/sh
# /opt/etc/init.d/S99sing-box-neofit-opkgtun
# üí° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NeoFit –¥–ª—è sing-box: —É—Å—Ç–∞–Ω–æ–≤–∫–∞, —É–¥–∞–ª–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

ACTION="$1"

# üõ† –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–º–ª–∏–Ω–∫–∞ neofit
if [ ! -L /opt/bin/neofit ] && [ ! -e /opt/bin/neofit ]; then
  rm -f /opt/bin/neofit
  ln -s /opt/etc/init.d/S99sing-box-neofit-opkgtun /opt/bin/neofit && echo "[üîó] –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ neofit —Å–æ–∑–¥–∞–Ω–∞\n–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É: neofit"
fi

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ br0
ip_address=$(ip addr show br0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_ok()   { echo -e "${GREEN}[‚úÖ]${NC} $1"; logger -t S99opkgtun0 "‚úÖ $1"; }
log_warn() { echo -e "${YELLOW}[‚ö†Ô∏è]${NC} $1"; logger -t S99opkgtun0 "‚ö†Ô∏è $1"; }
log_err()  { echo -e "${RED}[‚ùå]${NC} $1" >&2; logger -t S99opkgtun0 "‚ùå $1"; }
log()      { echo -e "${GREEN}[‚ÑπÔ∏è]${NC} $1"; logger -t S99opkgtun0 "‚ÑπÔ∏è $1"; }

ndmc_silent() {
  ndmc -c "$1" >/dev/null 2>&1
}

check_status() {
  STATUS=$(/opt/etc/init.d/S99sing-box status)
  if echo "$STATUS" | grep -qi "alive"; then
    log_ok "üîú sing-box —Ä–∞–±–æ—Ç–∞–µ—Ç: $STATUS"
  elif echo "$STATUS" | grep -qi "dead"; then
    log_err "üîú sing-box –ù–ï –∑–∞–ø—É—â–µ–Ω: $STATUS"
  else
    log_warn "üîú –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å sing-box: $STATUS"
  fi
}

if [ "$ACTION" = "start" ] || [ "$ACTION" = "restart" ]; then
  log_warn "‚ôªÔ∏è –£–¥–∞–ª—è—é link –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ opkgtun0"
  ip link delete opkgtun0 2>/dev/null
  log_warn "‚ôªÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–ª—É–∂–±—É sing-box"
  /opt/etc/init.d/S99sing-box restart >/dev/null 2>&1
  ip route del default via 172.16.250.2 dev opkgtun0 metric 1111 2>/dev/null
  ip route add default via 172.16.250.2 dev opkgtun0 metric 1111 2>/dev/null
  sleep 2
  check_status
  exit 0
fi

if [ "$ACTION" = "status" ]; then
  check_status
  exit 0
fi

if [ "$ACTION" = "stop" ]; then
  log_warn "‚ùå–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–ª—É–∂–±—É sing-box"
  /opt/etc/init.d/S99sing-box stop >/dev/null 2>&1
  sleep 2
  check_status
  exit 0
fi

if [ "$ACTION" = "myip" ]; then
  if ip link show t2s0 >/dev/null 2>&1; then
    log "üåç –ü—Ä–æ–≤–µ—Ä–∫–∞ IP —á–µ—Ä–µ–∑ Proxy0 (t2s0)"
    curl --interface t2s0 2ip.ru || log_warn "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP —á–µ—Ä–µ–∑ Proxy0"
  else
    log_warn "–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å t2s0 (Proxy0) –Ω–µ –Ω–∞–π–¥–µ–Ω"
  fi
  exit 0
fi

if [ "$ACTION" = "ping" ]; then
  if ip route | grep -q opkgtun0; then
    log "üì∂ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ opkgtun0"
    ping -I opkgtun0 1.1.1.1 -c 3 || log_warn "–ü–∏–Ω–≥ —á–µ—Ä–µ–∑ opkgtun0 –Ω–µ —É–¥–∞–ª—Å—è"
  else
    log_warn "–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å opkgtun0 –Ω–µ –Ω–∞–π–¥–µ–Ω"
  fi
  exit 0
fi

if [ "$ACTION" = "remove" ]; then
  log "üßπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ sing-box"
  /opt/etc/init.d/S99sing-box stop >/dev/null 2>&1
  sleep 1
  log "üßπ –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤"
  ndmc_silent "no interface Proxy0"
  ndmc_silent "no interface OpkgTun0"
  ndmc_silent "system configuration save"
  log "üßπ –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–Ω–∫–∞ opkgtun0"
  ip link delete opkgtun0 2>/dev/null
  ip route del default via 172.16.250.2 dev opkgtun0 metric 1111 2>/dev/null
  log_ok "üßπ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ –º–∞—Ä—à—Ä—É—Ç —É–¥–∞–ª–µ–Ω—ã"
  exit 0
fi

if [ "$ACTION" = "proxy0" ]; then
  log_warn "üîÅ –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Proxy0"
  ndmc_silent "no interface Proxy0"
  ndmc_silent "system configuration save"
  sleep 1
  ACTION="add-proxy0"
fi

if [ "$ACTION" = "add-proxy0" ]; then
  log "‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Proxy0 (–ª–æ–∫–∞–ª—å–Ω—ã–π IP: $ip_address)"
  ndmc_silent "interface Proxy0"
  ndmc_silent "interface Proxy0 description NeoFit-t.me/pegakmop-Proxy0-$ip_address:1080"
  ndmc_silent "interface Proxy0 proxy protocol socks5"
  ndmc_silent "interface Proxy0 proxy socks5-udp"
  ndmc_silent "interface Proxy0 proxy upstream $ip_address 1080"
  ndmc_silent "interface Proxy0 ip global 1"
  ndmc_silent "interface Proxy0 up"
  ndmc_silent "system configuration save"
  log_warn "üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ sing-box"
  /opt/etc/init.d/S99sing-box restart >/dev/null 2>&1
  sleep 1
  check_status
  exit 0
fi

if [ "$ACTION" = "del-proxy0" ]; then
  log_warn "üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Proxy0"
  ndmc_silent "no interface Proxy0"
  ndmc_silent "system configuration save"
  log_ok "üóëÔ∏è Proxy0 —É–¥–∞–ª—ë–Ω"
  exit 0
fi

if [ "$ACTION" = "opkgtun0" ]; then
  log_warn "üîÅ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ sing-box"
  /opt/etc/init.d/S99sing-box stop >/dev/null 2>&1
  sleep 1
  log_warn "üîÅ –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ OpkgTun0"
  ndmc_silent "no interface OpkgTun0"
  ndmc_silent "system configuration save"
  sleep 1
  ACTION="add-opkgtun0"
fi

if [ "$ACTION" = "add-opkgtun0" ]; then
  log "‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ OpkgTun0 (–∞–¥—Ä–µ—Å: 172.16.250.1)"
  ndmc_silent "interface OpkgTun0"
  ndmc_silent "interface OpkgTun0 description OpkgTun0"
  ndmc_silent "interface OpkgTun0 ip address 172.16.250.1/30"
  ndmc_silent "interface OpkgTun0 ip global 1"
  ndmc_silent "interface OpkgTun0 up"
  ndmc_silent "system configuration save"
  sleep 1
  log "‚ûï –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–Ω–∫–∞ opkgtun0"
  ip link delete opkgtun0 2>/dev/null
  ndmc_silent "system configuration save"

  if ip route | grep -q "dev opkgtun0"; then
    log "‚ûï –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ opkgtun0"
    ip route del default via 172.16.250.2 dev opkgtun0 metric 1111 2>/dev/null
    ip route add default via 172.16.250.2 dev opkgtun0 metric 1111 2>/dev/null
  else
    log "‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ opkgtun0"
    ip route add default via 172.16.250.2 dev opkgtun0 metric 1111 2>/dev/null
  fi

  log_warn "üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ sing-box"
  /opt/etc/init.d/S99sing-box restart >/dev/null 2>&1
  sleep 2
  check_status
  exit 0
fi

if [ "$ACTION" = "del-opkgtun0" ]; then
  log_warn "üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ OpkgTun0"
  ndmc_silent "no interface OpkgTun0"
  ndmc_silent "system configuration save"
  log_warn "üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–Ω–∫–∞ opkgtun0"
  ip link delete opkgtun0 2>/dev/null
  log_ok "üóëÔ∏è OpkgTun0 —É–¥–∞–ª—ë–Ω"
  exit 0
fi

if [ "$ACTION" = "install" ]; then
  log "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Proxy0 (–ª–æ–∫–∞–ª—å–Ω—ã–π IP: $ip_address)"
  ndmc_silent "interface Proxy0"
  ndmc_silent "interface Proxy0 description NeoFit-t.me/pegakmop-Proxy0-$ip_address:1080"
  ndmc_silent "interface Proxy0 proxy protocol socks5"
  ndmc_silent "interface Proxy0 proxy socks5-udp"
  ndmc_silent "interface Proxy0 proxy upstream $ip_address 1080"
  ndmc_silent "interface Proxy0 ip global 1"
  ndmc_silent "interface Proxy0 up"
  ndmc_silent "system configuration save"

  log "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ OpkgTun0 (–∞–¥—Ä–µ—Å: 172.16.250.1)"
  ndmc_silent "interface OpkgTun0"
  ndmc_silent "interface OpkgTun0 description OpkgTun0"
  ndmc_silent "interface OpkgTun0 ip address 172.16.250.1/30"
  ndmc_silent "interface OpkgTun0 ip global 1"
  ndmc_silent "interface OpkgTun0 up"
  ndmc_silent "system configuration save"

  log "üöÄ –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–Ω–∫–∞ opkgtun0"
  ip link delete opkgtun0 2>/dev/null
  ndmc_silent "system configuration save"

  if ip route | grep -q "dev opkgtun0"; then
    log "üöÄ –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ opkgtun0"
    ip route del default via 172.16.250.2 dev opkgtun0 metric 1111 2>/dev/null
    ip route add default via 172.16.250.2 dev opkgtun0 metric 1111 2>/dev/null
  else
    log "üöÄ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —á–µ—Ä–µ–∑ opkgtun0"
    ip route add default via 172.16.250.2 dev opkgtun0 metric 1111 2>/dev/null
  fi

  log_warn "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ sing-box"
  /opt/etc/init.d/S99sing-box restart >/dev/null 2>&1
  sleep 2
  check_status
  log_ok "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Proxy0 –∏ OpkgTun0 –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
  exit 0
fi

# üìé –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ /opt/bin/neofit
if [ ! -L /opt/bin/neofit ]; then
  if [ -e /opt/bin/neofit ]; then
    log_warn "‚ö†Ô∏è –§–∞–π–ª /opt/bin/neofit —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ —ç—Ç–æ –Ω–µ —Å—Å—ã–ª–∫–∞. –ü—Ä–æ–ø—É—Å–∫–∞—é —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–∞."
  else
    rm -f /opt/bin/neofit
    ln -s /opt/etc/init.d/S99sing-box-neofit-opkgtun /opt/bin/neofit && log_ok "üîó –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ neofit —Å–æ–∑–¥–∞–Ω–∞"
  fi
fi

log_warn "$0 \n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: neofit {start|stop|restart|status|myip|ping|remove|install|proxy0|add-proxy0|del-proxy0|opkgtun0|add-opkgtun0|del-opkgtun0}\n–ù–∞—à –∫–∞–Ω–∞–ª: t.me/neofitkeenetic \n–ù–∞—à —á–∞—Ç: t.me/+f_8QmNYgg180Njg6 \nGitHub: github.com/pegakmop/neofit"
exit 1
